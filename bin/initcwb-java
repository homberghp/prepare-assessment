#!/bin/bash
source ../default.properties
exam_date=$(d=$(pwd);d=${d: -8}; d1=${d:0:4}; d2=${d:4:2}; d3=${d:6:2}; echo ${d1}-${d2}-${d3})
event_name=${module_name}-${exam_date}
year=${exam_date:0:4}

webdir=${index_file_grand_parent}/${year}/${module_name}-${exam_date}
svnroot=${svn_location}/${year}/${event_name}
#hvd 20131101 store filename of question as well
rm -fr ${webdir}/harvest/sandbox
harvester ${svnroot} 
# echo continue work in ${webdir}
# cd ${webdir}
flag='editor-fold'
# hack 
#!/bin/bash
for i in $(grep -rl __STUDENT_ID__ ${webdir}/harvest/sandbox); do
    file=$i
    name=$(basename $(dirname $(dirname $(dirname $i))))
    sed -i "s/__STUDENT_ID__/(${name})/" $file 
done
echo snipping exam
for f in $(grep -rl ${flag} ${webdir}/harvest/sandbox/); do
#    echo ${f}; pass extension to snipper.
    cat $f | snipper ${f##*.}
done

echo snipping solution
for f in $(grep -rl __STUDENT_ID__ examsolution); do
    cat $f | snipper-sol ${f##*.}
done
# syntax colouring snippets 
echo colouring java snippets
for i in $(find ${webdir}/harvest -name "*.java.snippet"); do 
    ( enscript --line-numbers -whtml --style=emacs_verbose -Ejava -q  --color -p -  $i | stripsnip.pl > $i.html &); 
done

echo colouring xhtml snippets
for i in $(find ${webdir}/harvest -name "*.xhtml.snippet"); do 
    ( enscript --line-numbers -whtml --style=emacs_verbose -Ehtml -q  --color -p -  $i | stripsnip.pl > $i.html &);
done

# syntax colouring complete java files
echo colouring java complete files
for i in $(find ${webdir}/harvest -name "*.java"); do 
    ( enscript --line-numbers -whtml --style=emacs_verbose -Ejava  -q  --color -p -  $i | stripsnip.pl > $i.html &);
done

# syntax colouring xhtml complete files
echo colouring xhtml complete files
for i in $(find ${webdir}/harvest -name "*.xhtml"); do
    ( enscript --line-numbers -whtml --style=emacs_verbose -Ehtml -q  --color -p -  $i | stripsnip.pl > $i.html &); 
done

# link to resources
ln -sf /home/prepareassessment/resources/{cwb,index2,left,process,resultmail,results,setactive,top,wb}.php ${webdir}
ln -sf /home/prepareassessment/resources/*.css ${webdir}
ln -sf /home/prepareassessment/resources/{images,js,css} ${webdir}
cp paconfig/settings.php ${webdir}
