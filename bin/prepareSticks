#!/bin/bash
# steps: 
# 1. enumerated inserted sticks using /sys/block/sd{c..p} and regex
# 2. unmount them all
# 3. write partition table
# 4. create vfat and ext3 file system
# 4. label vfat to name stick, e.g. EXAM100 and ext3 part to casper-rw
# 5. syslinux --install  /dev/sd?1
# 6. mount vfat part to /media/hom/STICK-ID
# 7. cp -r /home/U14.04/ISO/. /media/hom/STICK-ID
debug=
if [ -z $stickclass ] ; then
    export stickclass=EXAM
fi
source stick_helpers.sh
scriptdir=$(dirname $(readlink -f $0))
ininum=100
if [ $# -ge 1 ]; then ininum=$1; shift; fi 
disks=$(enumerateSticks)
echo sticks found: $disks
IFS=','

# unmount if stll mounted
num=${ininum}
for d in $disks; do
    echo try umount partitions on ${d}
    for disk in /sys/block/${d}/${d}? ; do
	umount /dev/$(basename ${disk})
    done
done
sync

num=${ininum}
for d in $disks; do 
    printf -v LABEL "${stickclass}%3.3d" ${num}
     ( prepareStick ${d} ${LABEL} )& 
    num=$((num+1))
done
wait
echo done partioning sticks $disks
sync
# exit 0
num=${ininum}
for d in $disks; do 
    printf -v LABEL "${stickclass}%3.3d" ${num}
     ( installToStick ${d} ${LABEL} )& 
    num=$((num+1))
done

wait
sync
for d in $disks; do 
    echo done with stick ${d}
    ${debug} umount -d /dev/${d}1
done
echo next num=${num}
rm -fr /media/usb
paplay ${scriptdir}/programisready.ogg
